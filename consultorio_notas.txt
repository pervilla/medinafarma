CREATE TABLE dbo.ALLOG (
  ALL_CODCIA char(2) COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL,
  ALL_FECHA_DIA datetime NOT NULL,
  ALL_NUMOPER int NOT NULL,
  ALL_CODTRA numeric(4, 0) NULL,
  ALL_FLAG_EXT char(1) COLLATE SQL_Latin1_General_CP1_CI_AS DEFAULT 0 NULL,
  ALL_CODCLIE numeric(8, 0) CONSTRAINT DF_ALLOG_ALL_CODCLIE DEFAULT 0 NULL,
  ALL_CODART numeric(8, 0) DEFAULT 0 NULL,
  ALL_IMPORTE_AMORT numeric(11, 2) CONSTRAINT DF_ALLOG_ALL_IMPORTE_AMORT DEFAULT 0 NULL,
  ALL_IMPORTE numeric(11, 2) CONSTRAINT DF_ALLOG_ALL_IMPORTE DEFAULT 0 NULL,
  ALL_CHESER char(3) COLLATE SQL_Latin1_General_CP1_CI_AS DEFAULT 'i_c' NULL,
  ALL_SECUENCIA int CONSTRAINT DF_ALLOG_ALL_SECUENCIA DEFAULT 0 NULL,
  ALL_IMPORTE_DOLL numeric(11, 2) CONSTRAINT DF_ALLOG_ALL_IMPORTE_DOLL DEFAULT 0 NULL,
  ALL_CODUSU char(10) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  ALL_PRECIO numeric(11, 2) CONSTRAINT DF_ALLOG_ALL_PRECIO DEFAULT 0 NULL,
  ALL_CODVEN int CONSTRAINT DF_ALLOG_ALL_CODVEN DEFAULT 0 NULL,
  ALL_FBG char(1) COLLATE SQL_Latin1_General_CP1_CI_AS CONSTRAINT DF_ALLOG_ALL_FBG DEFAULT ' ' NULL,
  ALL_CP char(1) COLLATE SQL_Latin1_General_CP1_CI_AS CONSTRAINT DF_ALLOG_ALL_CP DEFAULT ' ' NULL,
  ALL_TIPDOC char(2) COLLATE SQL_Latin1_General_CP1_CI_AS CONSTRAINT DF_ALLOG_ALL_TIPDOC DEFAULT ' ' NULL,
  ALL_CANTIDAD numeric(11, 2) CONSTRAINT DF_ALLOG_ALL_CANTIDAD DEFAULT 0 NULL,
  ALL_NUMGUIA numeric(9, 0) CONSTRAINT DF_ALLOG_ALL_NUMGUIA DEFAULT 0 NULL,
  ALL_CODBAN numeric(9, 0) CONSTRAINT DF_ALLOG_ALL_CODBAN DEFAULT 0 NULL,
  ALL_AUTOCON char(150) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  ALL_CHENUM numeric(9, 0) CONSTRAINT DF_ALLOG_ALL_CHENUM DEFAULT 0 NULL,
  ALL_CHESEC char(3) COLLATE SQL_Latin1_General_CP1_CI_AS DEFAULT 0 NULL,
  ALL_NUMSER char(3) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  ALL_NUMFAC numeric(9, 0) NULL,
  ALL_FECHA_VCTO datetime NULL,
  ALL_NETO numeric(11, 2) CONSTRAINT DF_ALLOG_ALL_NETO DEFAULT 0.00 NULL,
  ALL_BRUTO numeric(11, 2) CONSTRAINT DF_ALLOG_ALL_BRUTO DEFAULT 0.00 NULL,
  ALL_GASTOS numeric(11, 2) CONSTRAINT DF_ALLOG_ALL_GASTOS DEFAULT 0.00 NULL,
  ALL_IMPTO numeric(11, 2) CONSTRAINT DF_ALLOG_ALL_IMPTO DEFAULT 0.00 NULL,
  ALL_DESCTO numeric(11, 2) CONSTRAINT DF_ALLOG_ALL_DESCTO DEFAULT 0.00 NULL,
  ALL_MONEDA_CAJA char(1) COLLATE SQL_Latin1_General_CP1_CI_AS CONSTRAINT DF_ALLOG_ALL_MONEDA_CAJA DEFAULT 'S' NULL,
  ALL_MONEDA_CCM char(1) COLLATE SQL_Latin1_General_CP1_CI_AS DEFAULT ' ' NULL,
  ALL_MONEDA_CLI char(1) COLLATE SQL_Latin1_General_CP1_CI_AS DEFAULT 'S' NULL,
  ALL_NUMDOC numeric(9, 0) CONSTRAINT DF_ALLOG_ALL_NUMDOC DEFAULT 0 NULL,
  ALL_LIMCRE_ANT numeric(11, 2) CONSTRAINT DF_ALLOG_ALL_LIMCRE_ANT DEFAULT 0 NULL,
  ALL_LIMCRE_ACT numeric(11, 2) CONSTRAINT DF_ALLOG_ALL_LIMCRE_ACT DEFAULT 0 NULL,
  ALL_TIPO_BLOQ_ANT char(4) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  ALL_TIPO_BLOQ_ACT char(4) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  ALL_CANT_CHEQ int CONSTRAINT DF_ALLOG_ALL_CANT_CHEQ DEFAULT 0 NULL,
  ALL_NUM_INI numeric(9, 0) NULL,
  ALL_NUM_OPER2 int CONSTRAINT DF_ALLOG_ALL_NUM_OPER2 DEFAULT 0 NULL,
  ALL_SIGNO_ARM int CONSTRAINT DF_ALLOG_ALL_SIGNO_ARM DEFAULT 1 NULL,
  ALL_CODTRA_EXT numeric(4, 0) NULL,
  ALL_SIGNO_CCM int CONSTRAINT DF_ALLOG_ALL_SIGNO_CCM DEFAULT 0 NULL,
  ALL_SIGNO_CAR int CONSTRAINT DF_ALLOG_ALL_SIGNO_CAR DEFAULT 0 NULL,
  ALL_SIGNO_CAJA int CONSTRAINT DF_ALLOG_ALL_SIGNO_CAJA DEFAULT 0 NULL,
  ALL_TIPMOV int CONSTRAINT DF_ALLOG_ALL_TIPMOV DEFAULT 0 NULL,
  ALL_NUMSER_C char(3) COLLATE SQL_Latin1_General_CP1_CI_AS DEFAULT 0 NULL,
  ALL_NUMFAC_C numeric(9, 0) DEFAULT 0 NULL,
  ALL_SERDOC int CONSTRAINT DF_ALLOG_ALL_SERDOC DEFAULT 0 NULL,
  ALL_TIPO_CAMBIO numeric(9, 7) NULL,
  ALL_FLETE numeric(11, 2) CONSTRAINT DF_ALLOG_ALL_FLETE DEFAULT 0 NULL,
  ALL_SUBTRA char(20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  ALL_HORA datetime NULL,
  ALL_FACART char(1) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  ALL_CONCEPTO char(255) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  ALL_NUMOPER2 int NULL,
  ALL_FECHA_ANT datetime DEFAULT getdate() NULL,
  ALL_SITUACION char(1) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  ALL_FECHA_SUNAT datetime DEFAULT getdate() NULL,
  ALL_FLAG_SO char(1) COLLATE SQL_Latin1_General_CP1_CI_AS CONSTRAINT DF_ALLOG_ALL_FLAG_SO DEFAULT ' ' NULL,
  ALL_IMPG1 numeric(13, 2) CONSTRAINT DF_ALLOG_ALL_IMPG1 DEFAULT 0 NULL,
  ALL_IMPG2 numeric(13, 2) CONSTRAINT DF_ALLOG_ALL_IMPG2 DEFAULT 0 NULL,
  ALL_CTAG1 char(12) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  ALL_CTAG2 char(12) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  ALL_CODSUNAT int CONSTRAINT DF_ALLOG_ALL_CODSUNAT DEFAULT 0 NULL,
  ALL_FECHA_PRO datetime DEFAULT getdate() NULL,
  ALL_FECHA_CAN datetime DEFAULT getdate() NULL,
  ALL_SERIE_REC smallint DEFAULT 0 NULL,
  ALL_NUM_RECIBO int CONSTRAINT DF_ALLOG_ALL_NUM_RECIBO DEFAULT 0 NULL,
  ALL_RUC char(12) COLLATE SQL_Latin1_General_CP1_CI_AS DEFAULT '' NULL,
  ALL_CC int CONSTRAINT DF_ALLOG_ALL_CC2 DEFAULT 0 NULL,
  ALL_ZONACC int CONSTRAINT DF_ALLOG_ALL_ZONACC DEFAULT 0 NULL,
  ALL_CODCAJ int CONSTRAINT DF_ALLOG_ALL_CODCAJ DEFAULT 1 NULL,
  ALL_ESTADO_FE int NULL,
  ALL_DOC_ELECTRONICO char(1) COLLATE Modern_Spanish_CI_AS CONSTRAINT DF_ALLOG_ALL_DOC_ELECTRONICO DEFAULT '' NULL,
  ALL_CAJA_NRO int DEFAULT 0 NULL,
  ALL_CAJA_ESTADO tinyint DEFAULT 1 NULL,
  CONSTRAINT PK_ALLOG2_1__10 PRIMARY KEY CLUSTERED (ALL_CODCIA, ALL_FECHA_DIA, ALL_NUMOPER)
    WITH (
      PAD_INDEX = OFF, IGNORE_DUP_KEY = OFF, STATISTICS_NORECOMPUTE = OFF,
      ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON)
)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX ALLOG10 ON dbo.ALLOG
  (ALL_CODCIA, ALL_FECHA_DIA)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX ALLOG1010 ON dbo.ALLOG
  (ALL_FECHA_PRO)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX ALLOG28 ON dbo.ALLOG
  (ALL_CODCIA, ALL_CODTRA, ALL_FLAG_EXT, ALL_SECUENCIA, ALL_SERIE_REC, ALL_NUM_RECIBO DESC)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX ALLOG29 ON dbo.ALLOG
  (ALL_CODCIA, ALL_CODTRA, ALL_SECUENCIA, ALL_SERIE_REC)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX ALLOG4 ON dbo.ALLOG
  (ALL_CODCIA, ALL_FECHA_SUNAT)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX ALLOG7 ON dbo.ALLOG
  (ALL_CODCIA, ALL_CODTRA, ALL_FECHA_SUNAT)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX ALLOG8 ON dbo.ALLOG
  (ALL_CODCIA, ALL_CODTRA, ALL_NUMSER, ALL_SIGNO_CCM)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX ALLOG9 ON dbo.ALLOG
  (ALL_NUMFAC, ALL_CODCIA, ALL_FBG, ALL_NUMSER, ALL_TIPMOV)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX CAJACENTROC ON dbo.ALLOG
  (ALL_CODCIA, ALL_FECHA_CAN)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER OFF
GO

CREATE TRIGGER dbo.Update_Stock_Paquetes ON dbo.ALLOG
WITH EXECUTE AS CALLER
FOR UPDATE
AS
DECLARE @ALL_CODCIA CHAR(2)
DECLARE @ALL_CODTRA INT
DECLARE @ALL_FLAG_EXT CHAR(1)
DECLARE @ALL_CODART INT
DECLARE @ALL_CANTIDAD INT
DECLARE @PA_CODART INT
DECLARE @PA_PROM INT
DECLARE @ALL_TIPMOV INT
SELECT
@ALL_CODCIA=ALL_CODCIA,
@ALL_CODTRA=ALL_CODTRA,
@ALL_FLAG_EXT=ALL_FLAG_EXT,
@ALL_TIPMOV=ALL_TIPMOV,
@ALL_CODART=ALL_CODART,
@ALL_CANTIDAD=ALL_CANTIDAD
FROM INSERTED
IF (@ALL_FLAG_EXT='E' AND @ALL_CODTRA='2400' AND @ALL_TIPMOV='70') 
 BEGIN
  DECLARE actualiza_cursos CURSOR  FOR
  SELECT PA_CODART,PA_PROM FROM PAQUETES
  WHERE PA_CODCIA=@ALL_CODCIA AND PA_CODPA=convert(int,@ALL_CODART)
  OPEN actualiza_cursos
  FETCH NEXT FROM actualiza_cursos INTO @PA_CODART,@PA_PROM
  WHILE (@@FETCH_STATUS=0)
   BEGIN
    UPDATE PAQUETES SET PA_CANTIDAD=PA_CANTIDAD-(@ALL_CANTIDAD*@PA_PROM)
    WHERE PA_CODCIA=@ALL_CODCIA AND PA_CODPA=convert(int,@ALL_CODART) AND PA_CODART=@PA_CODART
    FETCH NEXT FROM actualiza_cursos INTO @PA_CODART,@PA_PROM
   END
   CLOSE  actualiza_cursos
   DEALLOCATE actualiza_cursos
 END
GO


CREATE TABLE dbo.FACART (
  FAR_TIPMOV int NOT NULL,
  FAR_CODCIA char(2) COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL,
  FAR_NUMSER char(3) COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL,
  FAR_FBG char(1) COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL,
  FAR_NUMFAC numeric(9, 0) NOT NULL,
  FAR_NUMSEC int NOT NULL,
  FAR_FECHA datetime NULL,
  FAR_NUMOPER int CONSTRAINT DF_FACART_FAR_NUMOPER DEFAULT 0 NOT NULL,
  FAR_CODCLIE numeric(8, 0) CONSTRAINT DF_FACART_FAR_CODCLIE DEFAULT 0 NOT NULL,
  FAR_CODART numeric(8, 0) CONSTRAINT DF_FACART_FAR_CODART DEFAULT 0 NOT NULL,
  FAR_TRANSITO char(1) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  FAR_ESTADO char(1) COLLATE SQL_Latin1_General_CP1_CI_AS CONSTRAINT DF_FACART_FAR_ESTADO DEFAULT 'N' NOT NULL,
  FAR_NUMGUIA numeric(9, 0) CONSTRAINT DF_FACART_FAR_NUMGUIA DEFAULT 0 NULL,
  FAR_DIAS int CONSTRAINT DF_FACART_FAR_DIAS DEFAULT 0 NOT NULL,
  FAR_SIGNO_ARM int NULL,
  FAR_PRECIO numeric(13, 4) CONSTRAINT DF_FACART_FAR_PRECIO DEFAULT 0 NOT NULL,
  FAR_STOCK numeric(13, 4) CONSTRAINT DF_FACART_FAR_STOCK DEFAULT 0 NOT NULL,
  FAR_COSPRO numeric(13, 4) CONSTRAINT DF_FACART_FAR_COSPRO DEFAULT 0 NOT NULL,
  FAR_IMPTO numeric(11, 2) CONSTRAINT DF_FACART_FAR_IMPTO DEFAULT 0 NOT NULL,
  FAR_TOT_DESCTO numeric(11, 2) CONSTRAINT DF_FACART_FAR_TOT_DESCTO DEFAULT 0 NOT NULL,
  FAR_DESCTO numeric(7, 2) CONSTRAINT DF_FACART_FAR_DESCTO DEFAULT 0 NOT NULL,
  FAR_GASTOS numeric(11, 2) CONSTRAINT DF_FACART_FAR_GASTOS DEFAULT 0 NOT NULL,
  FAR_BRUTO numeric(11, 2) CONSTRAINT DF_FACART_FAR_BRUTO DEFAULT 0 NOT NULL,
  FAR_EQUIV numeric(11, 2) CONSTRAINT DF_FACART_FAR_EQUIV DEFAULT 0 NOT NULL,
  FAR_PORDESCTO1 numeric(11, 3) CONSTRAINT DF_FACART_FAR_PORDESCTO1 DEFAULT 0 NOT NULL,
  FAR_TIPO_CAMBIO numeric(7, 5) CONSTRAINT DF_FACART_FAR_TIPO_CAMBIO DEFAULT 0 NOT NULL,
  FAR_OTRA_CIA char(2) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  FAR_NUMSER_C char(3) COLLATE SQL_Latin1_General_CP1_CI_AS DEFAULT 0 NULL,
  FAR_NUMFAC_C numeric(9, 0) CONSTRAINT DF_FACART_FAR_NUMFAC_C DEFAULT 0 NOT NULL,
  FAR_NUMDOC numeric(9, 0) CONSTRAINT DF_FACART_FAR_NUMDOC DEFAULT 0 NOT NULL,
  FAR_CP char(1) COLLATE SQL_Latin1_General_CP1_CI_AS CONSTRAINT DF_FACART_FAR_CP DEFAULT ' ' NULL,
  FAR_LIMCRE_ANT numeric(9, 2) CONSTRAINT DF_FACART_FAR_LIMCRE_ANT DEFAULT 0 NOT NULL,
  FAR_LIMCRE_ACT numeric(9, 2) CONSTRAINT DF_FACART_FAR_LIMCRE_ACT DEFAULT 0 NOT NULL,
  FAR_TIPO_BLOQ_ANT1 char(1) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  FAR_TIPO_BLOQ_ANT2 char(1) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  FAR_KEY_DIRCLI int DEFAULT 0 NULL,
  FAR_RUC char(12) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  FAR_TIPO_BLOQ_ACT1 char(1) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  FAR_DOCCLI char(10) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  FAR_DIRCLI varchar(40) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  FAR_CLIENTE varchar(40) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  FAR_PRECIO_NETO numeric(11, 4) CONSTRAINT DF_FACART_FAR_PRECIO_NETO DEFAULT 0 NOT NULL,
  FAR_CODVEN int CONSTRAINT DF_FACART_FAR_CODVEN DEFAULT 0 NULL,
  FAR_UNIDADES numeric(9, 0) CONSTRAINT DF_FACART_FAR_UNIDADES DEFAULT 0 NULL,
  FAR_LITRO numeric(11, 3) CONSTRAINT DF_FACART_FAR_LITRO DEFAULT 0 NULL,
  FAR_FECHA_COMPRA datetime NULL,
  FAR_NUM_LOTE int CONSTRAINT DF_FACART_FAR_NUM_LOTE DEFAULT 0 NULL,
  FAR_CANTIDAD numeric(13, 4) CONSTRAINT DF_FACART_FAR_CANTIDAD DEFAULT 0 NULL,
  FAR_SIGNO_LOT int CONSTRAINT DF_FACART_FAR_SIGNO_LOT DEFAULT 0 NULL,
  FAR_CONCEPTO char(60) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  FAR_COD_SUNAT char(2) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  FAR_FLETE numeric(11, 2) CONSTRAINT DF_FACART_FAR_FLETE DEFAULT 0 NULL,
  FAR_CODART_REF numeric(8, 0) CONSTRAINT DF_FACART_FAR_CODART_REF DEFAULT 0 NULL,
  FAR_JABAS int CONSTRAINT DF_FACART_FAR_JABAS DEFAULT 0 NULL,
  FAR_DESCRI char(15) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  FAR_MORTAL int CONSTRAINT DF_FACART_FAR_MORTAL DEFAULT 0 NULL,
  FAR_PESO numeric(13, 4) CONSTRAINT DF_FACART_FAR_PESO DEFAULT 0 NULL,
  FAR_TOT_FLETE numeric(11, 2) CONSTRAINT DF_FACART_FAR_TOT_FLETE DEFAULT 0 NULL,
  FAR_EX_IGV char(1) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  FAR_SIGNO_CAR int CONSTRAINT DF_FACART_FAR_SIGNO_CAR DEFAULT 0 NULL,
  FAR_NUM_PRECIO char(1) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  FAR_FACTURACION_IGV char(1) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  FAR_SUBTRA char(20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  FAR_PEDSER int CONSTRAINT DF_FACART_FAR_PEDSER DEFAULT 0 NULL,
  FAR_PEDFAC numeric(9, 0) CONSTRAINT DF_FACART_FAR_PEDFAC DEFAULT 0 NULL,
  FAR_PEDSEC int CONSTRAINT DF_FACART_FAR_PEDSEC DEFAULT 0 NULL,
  FAR_ORDEN_UNIDADES int CONSTRAINT DF_FACART_FAR_ORDEN_UNIDADES DEFAULT 0 NULL,
  FAR_CODUSU char(10) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  FAR_MONEDA char(1) COLLATE SQL_Latin1_General_CP1_CI_AS CONSTRAINT DF_FACART_FAR_MONEDA DEFAULT 'S' NULL,
  FAR_COSTEO char(1) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  FAR_COSPRO_ANT numeric(13, 4) CONSTRAINT DF_FACART_FAR_COSPRO_ANT DEFAULT 0 NULL,
  FAR_COSTEO_REAL char(1) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  FAR_HORA char(12) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  FAR_SERGUIA smallint CONSTRAINT DF_FACART_FAR_SERGUIA DEFAULT 0 NULL,
  FAR_CANTIDAD_P numeric(13, 4) CONSTRAINT DF_FACART_FAR_ISLA DEFAULT 0 NULL,
  FAR_TURNO smallint CONSTRAINT DF_FACART_FAR_TURNO DEFAULT 0 NULL,
  FAR_TIPDOC char(2) COLLATE SQL_Latin1_General_CP1_CI_AS CONSTRAINT DF_FACART_FAR_TIPDOC DEFAULT ' ' NULL,
  FAR_ESTADO2 char(1) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  FAR_PORDESCTOS char(10) COLLATE SQL_Latin1_General_CP1_CI_AS CONSTRAINT DF_FACART_FAR_PORDESCTOS DEFAULT 0 NULL,
  FAR_FLAG_SO char(1) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  FAR_NUMOPER2 smallint CONSTRAINT DF_FACART_FAR_NUMOPER2 DEFAULT 0 NULL,
  FAR_OC varchar(15) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  FAR_COSPRO_SUP numeric(13, 4) CONSTRAINT DF_FACART_FAR_COSPRO_SUP DEFAULT 0 NULL,
  FAR_FECHA_PRO datetime NULL,
  FAR_FECHA_CAN datetime NULL,
  FAR_SUBTOTAL numeric(13, 2) CONSTRAINT DF_FACART_FAR_SUBTOTAL DEFAULT 0 NULL,
  FAR_CODLOT char(30) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
  FAR_ESTADO_FE int NULL,
  FAR_DOC_ELECTRONICO char(1) COLLATE Modern_Spanish_CI_AS CONSTRAINT DF_FACART_FAR_DOC_ELECTRONICO DEFAULT '' NULL,
  CONSTRAINT PK_FACARTNEW_1__11 PRIMARY KEY CLUSTERED (FAR_CODCIA, FAR_FBG, FAR_NUMFAC, FAR_NUMSEC, FAR_NUMSER, FAR_TIPMOV)
    WITH (
      PAD_INDEX = OFF, IGNORE_DUP_KEY = OFF, STATISTICS_NORECOMPUTE = OFF,
      ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON)
)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX FACART10 ON dbo.FACART
  (FAR_CODCIA, FAR_FECHA_COMPRA)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX FACART15 ON dbo.FACART
  (FAR_TIPMOV, FAR_CODCIA, FAR_FBG, FAR_NUMSER_C, FAR_NUMFAC_C)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX FACART16 ON dbo.FACART
  (FAR_FECHA, FAR_NUMOPER)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX FACART17 ON dbo.FACART
  (FAR_NUMFAC_C)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX FACART18 ON dbo.FACART
  (FAR_CODCIA, FAR_SERGUIA)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX FACART22 ON dbo.FACART
  (FAR_TIPMOV, FAR_CODCIA, FAR_NUMSER, FAR_FBG, FAR_ESTADO, FAR_CP, FAR_NUMFAC DESC)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX FACART23 ON dbo.FACART
  (FAR_CODCIA, FAR_NUMGUIA, FAR_SERGUIA, FAR_FBG, FAR_NUMFAC, FAR_ESTADO)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX FACART24 ON dbo.FACART
  (FAR_TIPMOV, FAR_CODCIA, FAR_NUMSER, FAR_FBG, FAR_CP)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX FACART25 ON dbo.FACART
  (FAR_CODCIA, FAR_NUMGUIA, FAR_SERGUIA)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX FACART3 ON dbo.FACART
  (FAR_CODART, FAR_CODCIA, FAR_ESTADO, FAR_SIGNO_ARM, FAR_COSPRO, FAR_FECHA_COMPRA, FAR_CANTIDAD)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX FACART4 ON dbo.FACART
  (FAR_TIPMOV, FAR_CODCIA, FAR_CODART, FAR_FECHA_COMPRA, FAR_ESTADO2, FAR_PRECIO, FAR_EQUIV, FAR_CANTIDAD)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX FACART5 ON dbo.FACART
  (FAR_TIPMOV, FAR_CODCIA, FAR_CODCLIE, FAR_CODART, FAR_ESTADO, FAR_NUMSER, FAR_NUMFAC, FAR_FBG, FAR_FECHA, FAR_DIAS, FAR_EQUIV, FAR_LITRO, FAR_CANTIDAD, FAR_DESCRI, FAR_SUBTOTAL)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX FACART9 ON dbo.FACART
  (FAR_CODCIA, FAR_FECHA_COMPRA, FAR_CODART, FAR_ESTADO, FAR_COSTEO, FAR_COSTEO_REAL)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX INDEX_FACART ON dbo.FACART
  (FAR_FBG, FAR_FECHA, FAR_NUMSER_C, FAR_NUMFAC_C)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX IX_DELETE_DIR ON dbo.FACART
  (FAR_CODCIA, FAR_CODCLIE, FAR_CP, FAR_KEY_DIRCLI)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX IX_FACART_FECHAS ON dbo.FACART
  (FAR_FECHA)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX IX_UPDATE_CANTIDAD ON dbo.FACART
  (FAR_TIPMOV, FAR_CODCIA, FAR_NUMSEC, FAR_TRANSITO, FAR_ESTADO, FAR_NUMSER_C, FAR_NUMFAC_C)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX kardex ON dbo.FACART
  (FAR_CODART, FAR_FECHA, FAR_CODCIA, FAR_ESTADO, FAR_TRANSITO, FAR_ESTADO2, FAR_FECHA_COMPRA DESC, FAR_HORA)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX notacred ON dbo.FACART
  (FAR_CODCIA, FAR_FBG, FAR_NUMFAC, FAR_NUMSEC, FAR_NUMSER, FAR_TIPMOV, FAR_CP)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE TRIGGER dbo.Update_Cantidad_P ON dbo.FACART
WITH EXECUTE AS CALLER
FOR UPDATE
AS
DECLARE @FAR_TIPMOV INT
DECLARE @FAR_CODCIA CHAR(2)
DECLARE @FAR_NUMSER_C CHAR(3)
DECLARE @FAR_NUMFAC_C NUMERIC(9,0)
DECLARE @FAR_CANTIDAD INT
DECLARE @FAR_ESTADO CHAR(1)
DECLARE @FAR_CODCLIE NUMERIC(8,0)
DECLARE @FAR_CP CHAR(1)
DECLARE @FAR_CODART INT
DECLARE @FAR_NUMDOC NUMERIC(9,0)
SELECT
@FAR_TIPMOV=FAR_TIPMOV, 
@FAR_CODCIA=FAR_CODCIA,
@FAR_NUMSER_C=FAR_NUMSER_C,
@FAR_NUMFAC_C=FAR_NUMFAC_C,
@FAR_CANTIDAD=FAR_CANTIDAD,
@FAR_ESTADO=FAR_ESTADO,
@FAR_CODCLIE=FAR_CODCLIE,
@FAR_CP=FAR_CP,
@FAR_CODART=FAR_CODART,
@FAR_NUMDOC=FAR_NUMDOC
FROM INSERTED
IF NOT (@FAR_CP='P' AND @FAR_ESTADO='E' AND @FAR_TIPMOV='25')
 BEGIN 
  RETURN
 END
UPDATE  FACART 
SET FAR_CANTIDAD_P=FAR_CANTIDAD_P-@FAR_CANTIDAD
WHERE FAR_TIPMOV='20' 
AND FAR_CODCIA=@FAR_CODCIA  AND 
 FAR_NUMSEC=CONVERT(INT,@FAR_NUMDOC)
AND FAR_NUMSER_C=@FAR_NUMSER_C 
AND FAR_NUMFAC_C=@FAR_NUMFAC_C 
AND FAR_ESTADO='N' AND FAR_TRANSITO='P'
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE TRIGGER dbo.Update_Cantidad_Paquetes ON dbo.FACART
WITH EXECUTE AS CALLER
FOR INSERT
AS
DECLARE @PA_CODART INT
DECLARE @PA_PROM TINYINT
DECLARE @PA_EQUIV TINYINT
DECLARE @FAR_TIPMOV INT
DECLARE @FAR_CODCIA CHAR(2)
DECLARE @FAR_ESTADO CHAR(1)
DECLARE @FAR_SIGNO_ARM INT
DECLARE @FAR_NUMSER CHAR(3)
DECLARE @FAR_NUMFAC NUMERIC(9,0)
DECLARE @FAR_CANTIDAD INT
DECLARE @FAR_CODCLIE NUMERIC(8,0)
DECLARE @FAR_CP CHAR(1)
DECLARE @FAR_CODART INT
DECLARE @FLAG_TIPO CHAR(1)
SELECT
@FAR_TIPMOV=FAR_TIPMOV, 
@FAR_CODCIA=FAR_CODCIA,
@FAR_ESTADO=FAR_ESTADO,
@FAR_SIGNO_ARM=FAR_SIGNO_ARM,
@FAR_NUMSER=FAR_NUMSER,
@FAR_NUMFAC=FAR_NUMFAC,
@FAR_CANTIDAD=FAR_CANTIDAD,
@FAR_CP=FAR_CP,
@FAR_CODART=FAR_CODART
FROM INSERTED
--OBTENER SI EL ARTICULO ES UN PAQUETE O MERCADERIA
SELECT @FLAG_TIPO=RTRIM(ART_FLAG_STOCK)  FROM ARTI WHERE ART_CODCIA=@FAR_CODCIA AND ART_KEY=@FAR_CODART
IF (@FLAG_TIPO='P' AND @FAR_TIPMOV='10')
 BEGIN 
 --SELECT * INTO PRUEBAPAQUETE FROM INSERTED
 DECLARE CUR_PAQUETES CURSOR FOR SELECT PA_CODART,PA_PROM,PA_EQUIV 
 FROM PAQUETES 
 WHERE PA_CODCIA=@FAR_CODCIA AND PA_CODPA=@FAR_CODART
 OPEN CUR_PAQUETES
 FETCH NEXT FROM CUR_PAQUETES INTO @PA_CODART,@PA_PROM,@PA_EQUIV
 WHILE @@FETCH_STATUS=0
  BEGIN
   UPDATE  PAQUETES 
   SET PA_CANTIDAD=PA_CANTIDAD + @FAR_SIGNO_ARM*(@FAR_CANTIDAD*@PA_PROM) --*@PA_EQUIV)
   WHERE PA_CODCIA=@FAR_CODCIA AND PA_CODPA=@FAR_CODART AND PA_CODART=@PA_CODART 
   FETCH NEXT FROM CUR_PAQUETES INTO @PA_CODART,@PA_PROM,@PA_EQUIV
  END
  CLOSE CUR_PAQUETES
  DEALLOCATE CUR_PAQUETES
 END
GO